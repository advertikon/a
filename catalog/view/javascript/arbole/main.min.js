function setFiltersWidth(){$(".filters-fixed .max-width").width($(".filters-wrapper").width())}function showPopup(e){$("#"+e).show(),$("body").addClass("show-popup"),$("#"+e).find(".swiper-container").length&&initPopupSlider()}function hidePopup(e){$("#"+e).hide(),$("body").removeClass("show-popup"),$("#"+e).find(".swiper-container").length&&$("#"+e).find(".swiper-container")[0].swiper.destroy(!0,!0)}function initMainSlider(){new Swiper(".gallery-wrapper .swiper-container",{loop:!1,slidesPerView:5,breakpoints:{1279:{slidesPerView:4},940:{slidesPerView:3},767:{slidesPerView:"auto"}}});var e=$(".gallery-wrapper .swiper-container")[0].swiper;$(document).on("click",".gallery-prev",function(){e.slidePrev()}),$(document).on("click",".gallery-next",function(){e.slideNext()})}function initPopupSlider(){new Swiper(".popup-body .swiper-container",{loop:!0,speed:400,slidesPerView:1,simulateTouch:!1,pagination:".popup-body .swiper-pagination",paginationClickable:!0,prevButton:".popup-body .swiper-prev",nextButton:".popup-body .swiper-next"})}function initGalleryItemSlider(){new Swiper(".gallery-item-wrapper .swiper-container",{loop:!0,speed:400,slidesPerView:1,pagination:".gallery-item-wrapper .swiper-pagination",paginationClickable:!0})}function initOtherSlider(){$(".gallery-other-wrapper").each(function(){var e=$(this),t=parseInt(e.attr("data-size")),a=parseInt(e.attr("data-size-1")),i=parseInt(e.attr("data-size-2")),n=parseInt(e.attr("data-size-3"));new Swiper(e.find(".swiper-container"),{loop:!0,speed:400,spaceBetween:10,slidesPerView:t,breakpoints:{1560:{slidesPerView:a,spaceBetween:6},1279:{slidesPerView:i,spaceBetween:6},767:{slidesPerView:n,spaceBetween:10}}})}),$(document).on("click",".gallery-other-wrapper .swiper-prev",function(){$(this).closest(".gallery-other-wrapper").find(".swiper-container")[0].swiper.slidePrev()}),$(document).on("click",".gallery-other-wrapper .swiper-next",function(){$(this).closest(".gallery-other-wrapper").find(".swiper-container")[0].swiper.slideNext()})}function initReviewSlider(){$(".review-slider-source .review-slide").each(function(e){$(".review-slider-imgs .img:eq(0)").append($(this).find("img:eq(0)")),$(".review-slider-imgs .img:eq(1)").append($(this).find("img:eq(0)"))}),$(".review-slider-text .text p").each(function(){var e=$(this),t=e.text().split(" "),a=e.children().length?e.children():e;a.empty();for(var i=0;i<t.length;i++)a.append("<span><i>"+t[i]+" </i></span>")})}function showPartView(e,t,a,i,n){$(".part-view .img img").attr("src",e),$(".part-name span").text(t),$(".part-size span").text(a),$(".part-weight i").text(i),$(".part-price i").text(n),$(".part-view").addClass("visible")}function hidePartView(){$(".part-view").removeClass("visible")}function initFabric(){canvas=new fabric.Canvas("canvas");var e=$(".basement").width(),t=$(".basement").height();canvas.setWidth(e),canvas.setHeight(t);var a=canvas.getCenter().left,i=canvas.getCenter().top,n="center";$(".canvas-necklace").length&&(i=20,n="top"),canvas.setBackgroundImage($(".basement img").attr("src"),canvas.renderAll.bind(canvas),{width:$(".basement img").width(),height:$(".basement img").height(),originX:"center",originY:n,left:a,top:i}),canvas.renderAll(),arguments.length&&(boundRect=new fabric.Rect({left:arguments[0][0]-50,top:arguments[0][1]-50,width:100,height:100,fill:"rgba(0,0,0,0)",hasControls:!1,selectable:!1,hoverCursor:"default"}),canvas.add(boundRect),canvas.fixedFilled=!1,2==arguments.length&&(boundRect2=new fabric.Rect({left:arguments[1][0]-50,top:arguments[1][1]-50,width:100,height:100,fill:"rgba(0,0,0,0)",hasControls:!1,selectable:!1,hoverCursor:"default"}),canvas.add(boundRect2))),canvas.on("object:moving",function(e){checkBounds(e.target)}),canvas.on("object:rotating",function(e){checkBounds(e.target)}),canvas.on("object:added",function(e){e.target.price=dragPrice,e.target.weight=dragWeight,updateProductOptions(1),checkPartsNumber()}),canvas.on("object:removed",function(e){dragPrice=e.target.price,dragWeight=e.target.weight,e.target.fixed&&(canvas.fixedFilled=!1,$(".canvas-container").removeClass("fixedFilled"),boundRect.opacity=1),updateProductOptions(-1),checkPartsNumber()}),canvas.on("selection:created",function(e){for(var t=canvas.getActiveGroup(),a=canvas.getObjects().filter(function(e){return e.fixed}),i=0;i<a.length;i++)t.removeWithUpdate(a[i]);canvas.renderAll()}),$("body").on("click",function(){canvas.deactivateAll().renderAll()}),$(".canvas-container").on("click",function(e){e.stopPropagation()}),customizeControls()}function customizeControls(){fabric.Canvas.prototype.customiseControls({tl:{action:"remove",cursor:"pointer"},tr:{action:"rotate",cursor:"crosshair"}},function(){canvas.renderAll()}),fabric.Object.prototype.customiseCornerIcons({settings:{borderColor:"#ffdcf4",cornerSize:40,cornerBackgroundColor:"#d13ca3",cornerShape:"circle",cornerPadding:15},tr:{icon:"assets/build/svg/rotate.svg"},tl:{icon:"assets/build/svg/remove.svg"}},function(){canvas.renderAll()}),fabric.Group.prototype._controlsVisibility={mt:!1,mb:!1,ml:!1,mr:!1,bl:!1,br:!1,mtr:!1,tr:!0,tl:!0}}function checkBounds(e){e.setCoords(),(e.getBoundingRect().top<20||e.getBoundingRect().left<20)&&(e.top=Math.max(e.top,e.top-e.getBoundingRect().top+20),e.left=Math.max(e.left,e.left-e.getBoundingRect().left+20)),(e.getBoundingRect().top+e.getBoundingRect().height>e.canvas.height-20||e.getBoundingRect().left+e.getBoundingRect().width>e.canvas.width-20)&&(e.top=Math.min(e.top,e.canvas.height-e.getBoundingRect().height+e.top-e.getBoundingRect().top-20),e.left=Math.min(e.left,e.canvas.width-e.getBoundingRect().width+e.left-e.getBoundingRect().left-20))}function addImage(e,t,a){canvas.deactivateAll().renderAll(),fabric.Image.fromURL(e,function(e){if(e.perPixelTargetFind=!0,e.targetFindTolerance=4,e.set({left:a,top:t,scaleX:.2988,scaleY:.2988}).setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,bl:!1,br:!1,mtr:!1}).setCoords(),canvas.add(e),void 0!==canvas.fixedFilled&&!canvas.fixedFilled){var i;canvas.fixedFilled=!0;var n=(i=$(".canvas[data-place-2]").length&&t>=canvas.height/2?boundRect2:boundRect).left+(i.width-e.width*e.scaleX)/2,r=i.top+(i.height-e.height*e.scaleY)/2;$(".canvas-container").addClass("fixedFilled"),e.set({left:n,top:r,lockMovementX:!0,lockMovementY:!0,fixed:!0}).setCoords(),canvas.renderAll()}})}function checkPartsNumber(){if(canvas.fixedFilled){var e=canvas.getObjects().filter(function(e){return e.fixed});if(canvas.getObjects().filter(function(e){return"image"==e.type&&!e.fixed}).length)for(t=0;t<e.length;t++)e[t].setControlsVisibility({tl:!1});else for(var t=0;t<e.length;t++)e[t].setControlsVisibility({tl:!0})}}function initFreeConstructor(){$(".part-img").draggable({containment:"document",appendTo:"body",scroll:!1,cursor:"-webkit-grabbing",revert:function(e){return $(".canvas-container").removeClass("hover"),!e},revertDuration:200,helper:"clone",start:function(){dragPrice=$(this).parent().attr("data-price"),dragWeight=$(this).parent().attr("data-weight"),dragImg=$(this).parent().attr("data-src"),$(".canvas-container").addClass("hover")}}),initFreeDroppable(canvas)}function initFreeDroppable(e){(void 0===e?$(".basement .part-place"):e).droppable({accept:".part-img",tolerance:"fit",drop:function(e,t){var a=$(t.helper),i=(a.clone(),a[0].getBoundingClientRect()),n=$(".part-place")[0].getBoundingClientRect(),r=i.left-n.left,o=i.top-n.top;addImage(dragImg,o,r),$(".canvas-container").removeClass("hover")}})}function updateProductOptions(e){var t=$(".constructor-total-price i"),a=t.text(),i=parseFloat(a)+e*parseFloat(dragPrice);t.text(i);var n=$(".constructor-total-weight i"),r=n.text(),o=parseFloat(r)+e*parseFloat(dragWeight);n.text(o),$(".edit-steps .product-info .product-price i").text($(".constructor-total-price i").text())}function zoomIt(e){canvas.setHeight(canvas.getHeight()*e),canvas.setWidth(canvas.getWidth()*e);var t=canvas.backgroundImage;t.width=t.width*e,t.height=t.height*e;var a=canvas.getCenter().left,i=canvas.getCenter().top,n="center";$(".canvas-necklace").length&&(i=20,n="top"),t.left=a,t.top=i,t.originY=n,t.originX="center";var r=canvas.getObjects();for(var o in r){var c=r[o].scaleX*e,s=r[o].scaleY*e,l=r[o].left*e,d=r[o].top*e;r[o].scaleX=c,r[o].scaleY=s,r[o].left=l,r[o].top=d,r[o].setCoords()}canvas.renderAll(),canvas.calcOffset()}function trimCanvas(){for(var e=canvas.getContext("2d"),t=canvas.width,a=e.getImageData(0,0,canvas.width,canvas.height),i=0,n=a.height,r=0,o=a.width;i<n&&rowBlank(a,t,i);)++i;for(;n-1>i&&rowBlank(a,t,n-1);)--n;for(;r<o&&columnBlank(a,t,r,i,n);)++r;for(;o-1>r&&columnBlank(a,t,o-1,i,n);)--o;var c=e.getImageData(r,i,o-r,n-i),s=document.createElement("canvas"),l=s.getContext("2d");return s.width=c.width,s.height=c.height,l.putImageData(c,0,0),s.toDataURL()}function rowBlank(e,t,a){for(var i=0;i<t;++i)if(0!==e.data[a*t*4+4*i+3])return!1;return!0}function columnBlank(e,t,a,i,n){for(var r=i;r<n;++r)if(0!==e.data[r*t*4+4*a+3])return!1;return!0}var dragPrice=0,dragWieght=0,dragImg=0,boundRect,boundRect2;jQuery(document).ready(function(e){if(e("#canvas").length)if(e(".canvas[data-place]").length){initFreeConstructor();var t=e(".canvas").attr("data-place").split(",");e(".canvas[data-place-2]").length?initFabric(t,e(".canvas").attr("data-place-2").split(",")):initFabric(t)}else initFreeConstructor(),initFabric();e(".jewellery-type input").click(function(){var t=e(this).attr("id"),a=e(this).attr("data-type");e(".btns button:not(.back)").attr("onclick","window.location='constructor_step_3-"+a+"-"+t+".php'")}),e(".gallery-wrapper").length&&initMainSlider(),e(".gallery-other-wrapper").length&&initOtherSlider(),e(".gallery-item-wrapper").length&&initGalleryItemSlider(),e(".review-slider-source").length&&initReviewSlider(),e(".scrollbar-outer").length&&e(".scrollbar-outer").scrollbar(),e(".footer .field input").focus(function(){e(this).closest(".field").addClass("focus")}),e(".footer .field input").blur(function(){e(this).closest(".field").removeClass("focus")}),e(".login-wrapper .field input, .checkout .field input").focus(function(){e(this).closest(".field").addClass("focus")}),e(".login-wrapper .field input, .checkout .field input").blur(function(){e(this).val().length||e(this).closest(".field").removeClass("focus fast")}),e(".login-wrapper .field input, .checkout .field input").each(function(){e(this).val().length&&e(this).closest(".field").addClass("focus fast")}),e(".decimal").keypress(function(e){if(!((e=e||event).ctrlKey||e.altKey||e.metaKey)){var t=getChar(e);if(null!=t)return!(t<"0"||t>"9")&&void 0}}),e(document).on("click",".currency-toggler .dropdown a",function(t){t.preventDefault();var a=e(".currency-toggler"),i=e(this),n=a.find(".dropdown a").index(i);i.addClass("active").siblings().removeClass("active"),a.find(".current").text(i.text());var r=a.find("select option:eq("+n+")").val();a.find("select").val(r).trigger("change")}),e(document).on("click",".constructor-total-wrapper .error-text .close",function(t){t.preventDefault(),e(this).closest(".error-text").remove()}),e(document).on("click",".eye",function(){var t=e(this).closest(".field").find("input");"text"==t.attr("type")?t.attr("type","password"):t.attr("type","text")}),e(document).on("click",".edit-toggler",function(){e(this).closest(".delivery-form").addClass("editing"),e(".payment-method button").attr("disabled","disabled")}),e(document).on("click",".delivery-form button",function(t){t.preventDefault(),e(this).closest(".delivery-form").removeClass("editing"),e(".payment-method button").removeAttr("disabled")}),e(document).on("change",".radio input",function(){var t=e(this),a=t.closest(".radio"),i=t.attr("name");e('.radio input[name="'+i+'"]').closest(".radio").removeClass("checked"),t.prop("checked")&&a.addClass("checked")}),e(document).on("click",".account-form button",function(t){e(this).closest("form").hasClass("editing")||(t.preventDefault(),e(this).closest("form").addClass("editing"))}),e(document).on("click",".plus",function(){var t=e(this).closest(".field").find("input"),a=t.val();t.val(a<99?++a:99)}),e(document).on("click",".minus",function(){var t=e(this).closest(".field").find("input"),a=t.val();t.val(a>1?--a:1)}),e(document).on("click","[data-popup]",function(t){t.preventDefault(),showPopup(e(this).attr("data-popup"))}),e(document).on("click",".popup .close, .popup",function(t){t.preventDefault(),hidePopup(e(this).closest(".popup").attr("id"))}),e(document).on("click",".popup-body, .popup",function(e){e.stopPropagation()}),e(document).on("click",".order-items-toggler",function(){e(".order-items").slideToggle()}),e(document).on("click",".search-toggler",function(t){t.preventDefault(),e(".search-wrapper").toggleClass("active"),e(this).toggleClass("active")}),e(document).on("click",".filters-toggler",function(t){t.preventDefault(),e(".filters-mobile").toggleClass("active")}),e(document).on("click",".menu-wrapper .search-link",function(t){t.preventDefault(),e(".search-wrapper").addClass("active"),e(".menu-wrapper, .menu-toggler").removeClass("active")}),e(document).on("click",".search-wrapper .close",function(t){t.preventDefault(),e(".search-wrapper, .search-toggler").removeClass("active")}),e(document).on("click",".filters-mobile .close",function(t){t.preventDefault(),e(".filters-mobile, .search-toggler").removeClass("active")}),e(document).on("click",".constructor-sidebar-toggler",function(t){t.preventDefault(),e(".cart-sidebar").removeClass("active"),e(".constructor-sidebar").toggleClass("active")}),e(document).on("click",".user-menu .cart-toggler, .cart-sidebar-toggler",function(t){t.preventDefault(),e(".constructor-sidebar").removeClass("active"),e(".cart-sidebar").toggleClass("active")}),e(document).on("change",".jewellery-type .type input",function(t){e(".constructor-wrapper button").removeAttr("disabled")}),e(document).on("change",".step-wrapper .product-item input",function(t){e(".constructor-wrapper button").removeAttr("disabled")}),e(document).on("click",".part-list img",function(t){t.preventDefault();var a=e(this).closest(".img");showPartView(a.attr("data-src"),a.attr("data-name"),a.attr("data-size"),a.attr("data-weight"),a.attr("data-price"))}),e(document).on("click",".part-view .close",function(e){e.preventDefault(),hidePartView()}),e(document).on("click",".parts-toggler",function(t){t.preventDefault(),e(this).toggleClass("active"),e(".edit-step").not(e(this).closest(".edit-step")).toggleClass("hidden"),e(".parts-wrapper").toggleClass("visible")}),e(document).on("click",".constructor-complete",function(t){t.preventDefault(),e(this).hide(),e(".zoom-controls, .constructor-total-wrapper").hide(),e(".edit-steps .product-info .product-price i").text(e(".constructor-total-price i").text()),e(".parts-toggler").removeClass("active"),e(".edit-step").not(e(this).closest(".edit-step")).removeClass("hidden"),e(".parts-wrapper").removeClass("visible"),e(".edit-step.active").removeClass("active"),e(".edit-step.step-5").addClass("active"),e(".edit-steps .product-info").addClass("visible"),e(".canvas-ring").length?fabric.Image.fromURL(e(".basement img").attr("src"),function(t){var a=canvas.getCenter().left,i=canvas.getCenter().top;t.set({left:0,top:0,clipTo:function(e){e.rect(-280,-280,560,280)}}),canvas.backgroundImage=!1,canvas.setBackgroundImage(t,canvas.renderAll.bind(canvas),{width:e(".basement img").width(),height:e(".basement img").height(),originX:"center",originY:"center",left:a,top:i}),canvas.renderAll(),e(".final-img").addClass("visible").children("img").attr("src",canvas.toDataURL()),e(".basement").hide()}):(e(".final-img").addClass("visible").children("img").attr("src",canvas.toDataURL()),e(".basement").hide())});var a=e(window).scrollTop(),i="down";e("body").hasClass("gallery-page")&&e(window).scroll(function(t){var n=e(this).scrollTop(),r=e(".filters-wrapper").offset().top;i=a<n?"down":"up",e(window).innerWidth()<768&&(r-=40),"down"==i?e(".filters-fixed").addClass("hide-filters"):e(".filters-fixed").removeClass("hide-filters"),n>r?e(".filters-fixed").addClass("fixed"):e(".filters-fixed").removeClass("fixed"),a=n}),e(document).on("click",".menu-toggler",function(t){t.preventDefault(),e(this).toggleClass("active"),e(".menu-wrapper").toggleClass("active")}),e(window).resize(function(){setFiltersWidth()}),setFiltersWidth(),e(document).on("click",".zoom-controls",function(t){t.preventDefault(),showPopup("image-zoom"),e(".basement-final").length?(e("#image-zoom .image-zoom .img img").attr("src",e(".basement-final img").attr("src")),e("#image-zoom .image-zoom").width(e(".basement-final").width())):(canvas.renderAll(),zoomIt(2),e(".canvas-necklace").length?e("#image-zoom .image-zoom .img img").attr("src",trimCanvas()):e("#image-zoom .image-zoom .img img").attr("src",canvas.toDataURL()),zoomIt(.5),e("#image-zoom .image-zoom").width(canvas.width)),e("#image-zoom input").val(1),e("#image-zoom").find(".img").panzoom("reset"),e("#image-zoom").find(".img").panzoom("zoom",1,{silent:!0})}),e("#image-zoom").find(".img").panzoom({$zoomRange:e("#image-zoom").find("input"),startTransform:"scale(1)",increment:.3,rangeStep:.05,maxScale:2,minScale:1,panOnlyWhenZoomed:!1,contain:"automatic"})});var canvas;